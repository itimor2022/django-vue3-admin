import{a0 as fe,a1 as de,a2 as me,U as w,Y as ye}from"./index.acfe672b.js";import{a as we,r as y,m as g,w as ge,o as v,c as ve,Q as P,R as K,T as z,ae as he,af as be,O as Q,b as xe,U as Le,L as Ue,n as Te}from"./vue.5d8927be.js";const Fe=we({name:"FsFileUploader",inheritAttrs:!1,props:{modelValue:{},limit:{type:Number},sizeLimit:{type:[Number,Object]},pixelLimit:{type:Object,required:!1},buildUrl:{default(){return l=>l}},buildUrls:{},button:{type:Object},listType:{type:String},beforeUpload:{type:Function},beforeUploadRequest:{type:Function},uploader:{type:Object},preview:{type:Object},valueType:{type:String,default:"url"},getFileName:{}},emits:["change","update:modelValue","success","exceed"],setup(l,n){const{ui:a}=de(),{t:c}=me(),r=y([]),h=y(),f=y(),Y=g(()=>l.getFileName||(async e=>{if(typeof e!="string")return console.warn("获取文件名失败，请配置getFileName"),e;const t=e.substring(e.lastIndexOf("/")+1),i=t.indexOf("?");return i>=0?t.substring(0,i):t}));function b(e){return l.valueType==="object"?e:e[l.valueType]}function $(e){const t=[];for(let i of e)t.push(b(i));return t}async function G(e){const t=[];for(let i of e){let o;typeof i=="string"||typeof i=="number"||typeof i=="boolean"||i instanceof Date?(o={url:void 0,key:i,value:i},l.valueType!=="object"&&(o[l.valueType]=i)):o=i,o[a.upload.id]||(o[a.upload.id]=Math.random()+""),o.status||(o.status=a.upload.status.success),t.push(o)}await B(t);for(const i of t)if(!i.name){const o=i.url||i.value;i.name=await Y.value(o,i)}return t}async function j(e){const t=[];for(let i of e){const o=i.response||i.fsRes,s={size:i.size,name:i.name,uid:i.uid,...o??i};t.push(s)}return await B(t),$(t)}async function x(e){const t=[];if(e==null||e.length===0){r.value=t;return}if(e instanceof Array)for(let o of e)t.push(o);else t.push(e);const i=await G(t);N(i)}async function H(){await V.onChange(),await V.onBlur()}async function J(e){let t=await W(e);O(t),Te(async()=>{await H()})}async function W(e){if(e==null||e.length===0)return l.limit===1?null:[];if(l.limit===1)return(await j(e))[0];const t=[];for(let i of e)a.upload.isSuccess(i)&&t.push(i);return await j(t)}async function B(e){let t=e.filter(i=>i.url==null);if(l.buildUrls){const i=t.map(s=>b(s)),o=await l.buildUrls(i);for(let s=0;s<t.length;s++)t[s].url=o[s]}else if(l.buildUrl)for(let i of t)i.url=await l.buildUrl(b(i));else for(let i of t)i.url=i.value||i.key}function I(e){n.emit("change",e)}function O(e){h.value=e,n.emit("update:modelValue",e)}const V=a.formItem.injectFormItemContext();ge(()=>l.modelValue,async e=>{I(e),e!==h.value&&await x(e)}),x(l.modelValue);function X(){return r.value.filter(e=>e.status===a.upload.status.uploading).length>0}function d(e,t){N(t),J(t)}function S(e,t,i){n.emit("success",{res:e,file:t,fileList:i}),d(t,i)}function E(e){let t;return e>1024*1024*1024?t=(e/(1024*1024*1024)).toFixed(2)+"G":e>1024*1024?t=(e/(1024*1024)).toFixed(2)+"M":t=Math.round(e/1024)+"K",t}const k=(e=!1)=>{const t=e?a.upload.limitAdd:0;return l.limit>0&&r.value.length>=l.limit+t};function Z(){a.message.warn(c("fs.extends.fileUploader.limitTip",[l.limit]))}function L(){if(k(!0))throw Z(),new Error("文件数量超限")}function ee(e){if(l.sizeLimit!=null){let t=l.sizeLimit,i=null;if(typeof l.sizeLimit=="number"?i=(o,s)=>{const p=E(s),u=E(e.size);a.message.warn(c("fs.extends.fileUploader.sizeLimitTip",[p,u]))}:(t=l.sizeLimit.limit,i=l.sizeLimit.tip),e.size>t){let o="文件大小超过限制，当前文件大小："+e.size/1024+"k";throw i(e.size,t),new Error(o)}}}const te=e=>{let t=0,i=0,o="";if(l.pixelLimit)Array.isArray(l.pixelLimit)?(t=l.pixelLimit[0],i=l.pixelLimit[1]||l.pixelLimit[0]||0,o=l.pixelLimit[2]||""):typeof l.pixelLimit=="object"&&(t=l.pixelLimit.width||0,i=l.pixelLimit.height||0,o=l.pixelLimit.tip||"");else return Promise.resolve(!0);let s=o||c("fs.extends.fileUploader.pixelLimitTip",[t,i]);return new Promise((p,u)=>{let D=new FileReader;D.onload=pe=>{var M;let _=(M=pe.target)==null?void 0:M.result,m=new Image;m.onload=function(){t&&m.width>t||i&&m.height>i?(a.message.warn(s),u(s)):p(!0)},m.onerror=function(Pe){a.message.warn(c("fs.extends.fileUploader.loadError")),u(c("fs.extends.fileUploader.loadError"))},_&&(m.src=_)},D.readAsDataURL(e)})},U=async(e,t=r.value)=>{if(!(l.beforeUpload&&await l.beforeUpload({file:e,fileList:r.value})===!1))try{L(),ee(e),F()&&await te(e)}catch{return!1}};function N(e){r.value=e}async function ie(e){e.options=l.uploader||{};const{getUploaderImpl:t}=ye();let i=await t(e.options.type);if(i==null)throw a.message.warn("Sorry，The uploader component is not ready yet"),new Error("Sorry，The component is not ready yet");return await(i==null?void 0:i.upload(e))}async function T(e){l.beforeUploadRequest&&await l.beforeUploadRequest(e);const{file:t,onProgress:i,onSuccess:o,onError:s}=e,p={file:t,fileName:t.name,onProgress:i};try{const u=await ie(p);o(u)}catch(u){console.error("上传失败",u),s(u)}}const le=g(()=>se()?{is:"FsIcon",icon:a.icons.plus}:{is:"FsButton",icon:a.icons.upload,text:c("fs.extends.fileUploader.text"),...l.button}),q=y(!1),A=y(),oe=g(()=>({...a.dialog.footer(),...l.preview}));function ae(e){return new Promise((t,i)=>{const o=new FileReader;o.readAsDataURL(e),o.onload=()=>t(o.result),o.onerror=s=>i(s)})}function F(){return l.listType===a.upload.typeImageCard||l.listType===a.upload.typeImage}function se(){return l.listType===a.upload.typeImageCard}const R=async e=>{var t,i;if(!F()){let o;e.url?o=e.url:a.type==="antdv"?o=(t=e.response)==null?void 0:t.url:a.type==="element"?o=(i=e.fsRes)==null?void 0:i.url:o=e.url,window.open(o,"_blank")}!e.url&&!e.preview&&e.originFileObj&&(e.preview=await ae(e.originFileObj)),A.value=e.url||e.preview,q.value=!0};function ne(){const e={customRequest:T,beforeUpload:U,listType:l.listType,onChange:t=>{const{file:i,fileList:o}=t;d(i,o)},onPreview:R};return l.limit!=null&&n.attrs.maxCount==null&&(e.maxCount=l.limit),e}function re(){return{action:"",listType:l.listType,beforeUpload:U,httpRequest:T,onExceed:()=>{L(),n.emit("exceed",{fileList:r.value})},onRemove:(e,t)=>{d(e,t)},onChange:(e,t)=>{d(e,t)},onSuccess:(e,t,i)=>{e!=null&&(t.response=e,t.fsRes=e,S(e,t,i))},onPreview:R}}const C={};function ue(){function e(t){let i=t.value||t;i=w.cloneDeep(i);for(let o of i){const s=C[o.id];s&&w.merge(o,s)}return i}return{action:"",listType:l.listType,onBeforeUpload:async({file:t,fileList:i})=>U(t,i),customRequest:t=>{const i=t.file;T({...t,file:i.file,onSuccess:async o=>{const s=l.valueType==="object"?o:o[l.valueType];o.url=await l.buildUrl(s),w.merge(i,o),C[i.id]={...o,fsRes:o},t.onFinish(i)},onProgress:o=>{t.onProgress(o)}})},onExceed:()=>{L(),n.emit("exceed",{fileList:r.value})},onRemove:t=>{},onChange:t=>{const{event:i,file:o,fileList:s}=t,p=e(s);d(o,[...p])},onFinish:t=>{const i=C[t.id];i&&w.merge(t,i);const o=e(r);S(i,t,o)},onPreview:R}}const ce=g(()=>{let e=null;return a.type==="antdv"?e=ne():a.type==="element"?e=re():e=ue(),{...e,...n.attrs}});return{ui:a,fileList:r,fileUploaderRef:f,initValue:x,onChange:I,onInput:O,hasUploading:X,isPicture:F,computedFileSelectBtn:le,previewVisible:q,previewImage:A,computedPreview:oe,computedOnLimit:k,computedBinding:ce}}}),Re=["src"];function Ce(l,n,a,c,r,h){return v(),ve("div",{class:Ue(["fs-file-uploader",{"fs-file-uploader-limit":l.computedOnLimit()}])},[(v(),P(z(l.ui.upload.name),Q({ref:"fileUploaderRef",fileList:l.fileList,"onUpdate:fileList":n[0]||(n[0]=f=>l.fileList=f)},l.computedBinding),{default:K(()=>[(v(),P(z(l.computedFileSelectBtn.is),he(be(l.computedFileSelectBtn)),null,16))]),_:1},16,["fileList"])),l.isPicture()?(v(),P(z(l.ui.dialog.name),Q({key:0,[l.ui.dialog.visible]:l.previewVisible,["onUpdate:"+l.ui.dialog.visible]:n[1]||(n[1]=f=>l.previewVisible=f)},l.computedPreview),{default:K(()=>[xe("img",{style:{"max-width":"100%","max-height":"100%"},src:l.previewImage},null,8,Re)]),_:1},16)):Le("",!0)],2)}const Be=fe(Fe,[["render",Ce]]);export{Be as default};
