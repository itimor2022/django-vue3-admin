import{a0 as $,a1 as A,Y as G}from"./index.acfe672b.js";import{a as X,r as d,w as Y,k as J,ak as I,o as i,c as p,b as m,Q as w,R as B,F as K,aa as M,T as N,O as Z,X as g,U as h,L as O,a0 as ee}from"./vue.5d8927be.js";const ae=X({name:"FsCropperUploader",props:{disabled:{},modelValue:{type:[String,Object,Array]},img:{},type:{type:String},uploadTip:{type:String},title:String,cropperHeight:{type:[String,Number]},dialogWidth:{type:[String,Number],default:"50%"},maxSize:{type:Number,default:5},limit:{type:Number,default:1},accept:{type:String,default:".jpg, .jpeg, .png, .gif, .webp"},cropper:{type:Object},uploader:{type:Object},compressQuality:{type:Number,default:.8},buildUrl:{type:Function,default:async function(e){return typeof e=="object"?e.url:e}},valueType:{type:String,default:"url"}},emits:["update:modelValue","change","ready"],setup(e,n){const{ui:b}=A(),f=d(),V=d(),C=d(),r=d([]),u=b.formItem.injectFormItemContext();let y=e.modelValue;t(e.modelValue);async function t(a){const o=[];if(a==null||a===""){r.value=o;return}if(typeof a=="string")o.push({url:await e.buildUrl(a),value:a,status:"done"});else if(typeof a=="object")o.push({url:await e.buildUrl(a),value:a,status:"done"});else for(const l of a)o.push({url:await e.buildUrl(l),value:l,status:"done"});r.value=o}function v(){e.disabled||(C.value=void 0,f.value.clear(),f.value.open())}function U(a){r.value.splice(a,1),x()}function P(){const a=r.value;if(a&&a.length>0){for(const o of a)if(o.status==="uploading")return!0}return!1}async function D(a){const o=a.blob,l=a.dataUrl,F=a.file.name,H=new File([o],F,{type:o.type}),c=ee({url:void 0,dataUrl:l,status:"uploading",progress:0}),L=s=>{c.progress=s.percent},z=s=>{c.status="error",c.message="文件上传出错:"+s.message,console.error(s)},W={file:H,onProgress:L,onError:z,fileName:F};r.value.push(c);try{const s=await j(W);let S=s;e.valueType!=="object"&&(S=s[e.valueType]),c.url=await e.buildUrl(S),c.value=S,c.status="done",x()}catch(s){z(s)}}async function j(a){a.options=e.uploader||{};const{getUploaderImpl:o}=G();let l=await o(a.options.type);if(l==null)throw new Error("Sorry，The component is not ready yet");return await(l==null?void 0:l.upload(a))}async function x(){const a=[];for(const l of r.value)typeof l=="string"?a.push(l):a.push(l.value);let o=a;e.limit===1&&(o=a&&a.length>0?a[0]:void 0),y=o,n.emit("update:modelValue",o),await u.onChange(),await u.onBlur()}function T(a){return a.dataUrl?a.dataUrl:a.url}const k=d(!1),R=d();function Q(a){k.value=!0,R.value=T(a)}function _(){k.value=!1,R.value=null}Y(()=>e.modelValue,async a=>{n.emit("change",a),a!==y&&await t(a)});const q=J();function E(a){n.emit("ready",{uploaderRef:q,...a})}return{ui:b,cropperRef:f,uploaderImplRef:V,indexRef:C,listRef:r,addNewImage:v,hasUploading:P,cropComplete:D,doUpload:j,removeImage:U,getImageSrc:T,previewUrl:R,previewVisible:k,preview:Q,closePreview:_,doReady:E}}}),oe={class:"image-list"},te={class:"image-slot"},le={class:"delete"},ie={key:0,class:"status-uploading"},re={key:1,class:"status-done"},se={class:"fs-cropper-preview-content"},ne=["src"];function ue(e,n,b,f,V,C){const r=I("fs-loading"),u=I("fs-icon"),y=I("fs-cropper");return i(),p("div",{class:O(["fs-cropper-uploader",{"is-disabled":e.disabled}])},[m("div",oe,[(i(),w(N(e.ui.imageGroup.name),null,{default:B(()=>[(i(!0),p(K,null,M(e.listRef,(t,v)=>(i(),p("div",{key:v,class:"image-item"},[(i(),w(N(e.ui.image.name),Z({class:"image",src:e.getImageSrc(t),ref_for:!0},e.img),{placeholder:B(()=>[m("div",te,[g(r,{loading:!0})])]),_:2},1040,["src"])),m("div",le,[e.disabled?h("",!0):(i(),w(u,{key:0,icon:e.ui.icons.remove,onClick:U=>e.removeImage(v)},null,8,["icon","onClick"])),g(u,{icon:e.ui.icons.search,onClick:U=>e.preview(t)},null,8,["icon","onClick"])]),t.status==="uploading"?(i(),p("div",ie,[(i(),w(N(e.ui.progress.name),{type:"circle",percentage:t.progress,width:70},null,8,["percentage"]))])):t.status==="done"?(i(),p("div",re,[g(u,{icon:e.ui.icons.check,class:"status-down-icon"},null,8,["icon"])])):h("",!0)]))),128)),e.limit<=0||e.limit>e.listRef.length?(i(),p("div",{key:0,class:"image-item image-plus",onClick:n[0]||(n[0]=(...t)=>e.addNewImage&&e.addNewImage(...t))},[g(u,{icon:e.ui.icons.plus,class:"cropper-uploader-icon"},null,8,["icon"])])):h("",!0)]),_:1}))]),g(y,{ref:"cropperRef",title:e.title,"cropper-height":e.cropperHeight,"dialog-width":e.dialogWidth,accept:e.accept,"upload-tip":e.uploadTip,"max-size":e.maxSize,cropper:e.cropper,"compress-quality":e.compressQuality,output:"all",onDone:e.cropComplete,onReady:e.doReady},null,8,["title","cropper-height","dialog-width","accept","upload-tip","max-size","cropper","compress-quality","onDone","onReady"]),m("div",{class:O(["fs-cropper-preview",{open:e.previewVisible}]),onClick:n[1]||(n[1]=(...t)=>e.closePreview&&e.closePreview(...t))},[m("div",se,[e.previewUrl?(i(),p("img",{key:0,src:e.previewUrl,class:"preview-image"},null,8,ne)):h("",!0)])],2)],2)}const de=$(ae,[["render",ue]]);export{de as default};
