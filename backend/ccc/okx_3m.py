# -*- coding: utf-8 -*-

import requests
import json
import time
import datetime
import hmac
import base64
import pandas as pd

pd.options.display.width = 200
pd.options.display.max_columns = None
pd.options.display.max_rows = None

'''para
'''
t = int(time.time())
period = '3m'
chat_id = "-1002086380388"
GET = "GET"
POST = "POST"
API_URL = 'https://www.okx.com'
SERVER_TIMESTAMP_URL = '/api/v5/public/time'
# header
APPLICATION_JSON = 'application/json'
CONTENT_TYPE = 'Content-Type'
OK_ACCESS_KEY = 'OK-ACCESS-KEY'
OK_ACCESS_SIGN = 'OK-ACCESS-SIGN'
OK_ACCESS_TIMESTAMP = 'OK-ACCESS-TIMESTAMP'
OK_ACCESS_PASSPHRASE = 'OK-ACCESS-PASSPHRASE'


def send_message(msg, chat_id="-4591709428"):
    token1 = "7114302"
    token2 = "389:AAHaFEzUwXj7QC1A20qwi_tJGlkRtP6FOlg"
    url = f"https://api.telegram.org/bot{token1}{token2}/sendMessage?chat_id={chat_id}&text={msg}&parse_mode=HTML"
    r = requests.get(url)
    print(r.json())


##############################################################
##############################################################
'''
mod
'''


class base():
    def clean_dict_none(d: dict) -> dict:
        return {k: d[k] for k in d.keys() if d[k] != None}

    def get_timestamp():
        now = datetime.datetime.utcnow()
        t = now.isoformat("T", "milliseconds")
        return t + "Z"

    def sign(message, secretKey):
        mac = hmac.new(bytes(secretKey, encoding='utf8'), bytes(message, encoding='utf-8'), digestmod='sha256')
        d = mac.digest()
        return base64.b64encode(d)

    def pre_hash(timestamp, method, request_path, body):
        return str(timestamp) + str.upper(method) + request_path + body

    def get_header(api_key, sign, timestamp, passphrase, flag):
        header = dict()
        header[CONTENT_TYPE] = APPLICATION_JSON
        header[OK_ACCESS_KEY] = api_key
        header[OK_ACCESS_SIGN] = sign
        header[OK_ACCESS_TIMESTAMP] = str(timestamp)
        header[OK_ACCESS_PASSPHRASE] = passphrase
        header['FLAG'] = flag
        return header

    def parse_para_to_str(para):
        para = base.clean_dict_none(para)
        url = '?'
        for key, value in para.items():
            url = url + str(key) + '=' + str(value) + '&'
        return url[0:-1]


class Client(object):

    def __init__(self, api_key, api_secret_key, passphrase, use_server_time=False, flag='1'):

        self.API_KEY = api_key
        self.API_SECRET_KEY = api_secret_key
        self.PASSPHRASE = passphrase
        self.use_server_time = use_server_time
        self.flag = flag

    def _request(self, method, request_path, para):

        if method == GET:
            request_path = request_path + base.parse_para_to_str(para)
        # url
        url = API_URL + request_path
        print(url)

        timestamp = base.get_timestamp()

        # sign & header
        if self.use_server_time:
            timestamp = self.get_timestamp()

        body = json.dumps(para) if method == POST else ""

        sign = base.sign(base.pre_hash(timestamp, method, request_path, str(body)), self.API_SECRET_KEY)
        header = base.get_header(self.API_KEY, sign, timestamp, self.PASSPHRASE, self.flag)
        response = None
        if method == GET:
            response = requests.get(url, headers=header)
        elif method == POST:
            response = requests.post(url, data=body, headers=header)

        return response.json()

    def request_with_para(self, method, request_path, para):
        return self._request(method, request_path, para)

    def get_timestamp(self):
        url = API_URL + SERVER_TIMESTAMP_URL
        response = requests.get(url)
        if response.status_code == 200:
            return response.json()['ts']
        else:
            return ""


class MarketAPI(Client):

    def __init__(self, api_key, api_secret_key, passphrase, use_server_time=False, flag='1'):
        Client.__init__(self, api_key, api_secret_key, passphrase, use_server_time, flag)

    def get_history_candlesticks(self, instId, after=None, before=None, bar=None, limit=None):
        url = '/api/v5/market/history-candles'
        para = {'instId': instId, 'after': after, 'before': before, 'bar': bar, 'limit': limit}
        return self.request_with_para(GET, url, para)


def format_time(time_stamp, tz=0):
    dt = datetime.datetime.fromtimestamp(time_stamp)
    # ËÆæÁΩÆÊó∂Âå∫
    x = dt.astimezone(datetime.timezone(datetime.timedelta(hours=tz)))
    # Ê†ºÂºèÂåñÊó•Êúü
    dd = x.strftime("%Y-%m-%d %H:%M:%S %Z%z")
    return dd


def get_coin():
    period = '5m'
    # ÁÉ≠Èó®Ê¶ú
    url = f"https://www.okx.com/priapi/v5/rubik/web/public/hot-rank?countryFilter=1&rank=0&zone=utc8&period={period}&type=USDT&t={t}"
    # Êàê‰∫§È¢ù
    # url = f"https://www.okx.com/priapi/v5/rubik/web/public/turn-over-rank?countryFilter=1&rank=0&zone=utc8&period={period}&type=USDT&t={t}"
    # pair_list = ['CATI-USDT']
    r = requests.get(url)
    c = r.json()['data']['data'][:15]
    print(c)


def get_coin_data(coin):
    title = f'üèÜ{coin}üèÜ\n'
    # result = marketAPI.get_history_candlesticks(coin, bar=period)['data']
    result = [['1741660800000', '79112.3', '79251.7', '79056.7', '79140.8', '48.65328764', '3850490.951611951', '3850490.951611951', '1'], ['1741660500000', '79112.7', '79302.8', '79065', '79112.4', '33.80716246', '2676042.190299476', '2676042.190299476', '1'], ['1741660200000', '79278.3', '79320.5', '79093.3', '79118.3', '38.17102745', '3023045.797000403', '3023045.797000403', '1'], ['1741659900000', '79409.8', '79449.9', '79238', '79278.4', '41.11968526', '3262165.154801674', '3262165.154801674', '1'], ['1741659600000', '79421.4', '79653.8', '79392.1', '79408.1', '62.36263164', '4959409.132327848', '4959409.132327848', '1'], ['1741659300000', '79326.3', '79433.9', '79140.4', '79421.5', '57.1865158', '4533314.794998617', '4533314.794998617', '1'], ['1741659000000', '79424', '79475', '79255', '79326.2', '46.23339829', '3669506.098214853', '3669506.098214853', '1'], ['1741658700000', '79043.9', '79493.3', '78910', '79423.8', '107.32377439', '8504682.494806672', '8504682.494806672', '1'], ['1741658400000', '79122.2', '79452', '79000', '79044', '87.64538678', '6944316.347394497', '6944316.347394497', '1'], ['1741658100000', '78853.9', '79135.4', '78738.6', '79120.1', '60.42874402', '4771866.043164504', '4771866.043164504', '1'], ['1741657800000', '78806.1', '79083.2', '78738.8', '78850.1', '172.64457888', '13629600.156497033', '13629600.156497033', '1'], ['1741657500000', '78958', '78959.3', '78579.2', '78814.2', '219.03975489', '17240272.945204581', '17240272.945204581', '1'], ['1741657200000', '78416', '78958', '78400', '78957.9', '174.60866008', '13731307.29946564', '13731307.29946564', '1'], ['1741656900000', '78201.6', '78674.4', '78085.1', '78416', '183.39046894', '14389081.713614677', '14389081.713614677', '1'], ['1741656600000', '77764.6', '78416.5', '77735.1', '78201.7', '278.79756214', '21787631.235471715', '21787631.235471715', '1'], ['1741656300000', '77530.1', '77834.8', '77503', '77764.6', '145.08646261', '11269713.240248092', '11269713.240248092', '1'], ['1741656000000', '77267.7', '77554.9', '77124.1', '77526.3', '80.18257214', '6201716.786828502', '6201716.786828502', '1'], ['1741655700000', '77130.3', '77478.3', '76999.8', '77271.2', '86.05575317', '6645869.077038988', '6645869.077038988', '1'], ['1741655400000', '76989.9', '77443.1', '76888', '77130.3', '117.46147044', '9062397.510910397', '9062397.510910397', '1'], ['1741655100000', '77157.8', '77351', '76817.1', '76990', '94.37084966', '7273662.517237159', '7273662.517237159', '1'], ['1741654800000', '77675', '77735.9', '77158.1', '77158.1', '70.24374559', '5440246.319988888', '5440246.319988888', '1'], ['1741654500000', '77192.5', '77725.1', '77000', '77675', '116.0288318', '8974736.371414852', '8974736.371414852', '1'], ['1741654200000', '76944', '77199.7', '76600', '77192.5', '305.76956007', '23512605.632758112', '23512605.632758112', '1'], ['1741653900000', '76819.9', '77285.9', '76792', '76944', '119.99844472', '9239169.407242107', '9239169.407242107', '1'], ['1741653600000', '76940.2', '77266.5', '76800', '76814.6', '130.0491305', '10014869.230325894', '10014869.230325894', '1'], ['1741653300000', '77075.9', '77498.1', '76790', '76940.2', '397.95637661', '30650052.625709826', '30650052.625709826', '1'], ['1741653000000', '77317.9', '77534.7', '77000', '77075.4', '329.6174865', '25435497.859954097', '25435497.859954097', '1'], ['1741652700000', '77778.1', '78060.5', '77301.3', '77315.9', '221.33288814', '17173435.587123915', '17173435.587123915', '1'], ['1741652400000', '78443.2', '78443.2', '77675.3', '77782.2', '163.60690072', '12757953.519269501', '12757953.519269501', '1'], ['1741652100000', '78762', '78774.7', '78258.9', '78444.9', '44.66339521', '3504892.644635841', '3504892.644635841', '1'], ['1741651800000', '79056.9', '79056.9', '78694.4', '78762.1', '34.76890207', '2741597.353010632', '2741597.353010632', '1'], ['1741651500000', '78970.1', '79238.5', '78889.1', '79058.8', '39.6565033', '3135720.115141301', '3135720.115141301', '1'], ['1741651200000', '78595.9', '78982.8', '78595.9', '78970', '32.97071583', '2598272.332274421', '2598272.332274421', '1'], ['1741650900000', '78791.4', '78897.9', '78494.2', '78595.8', '80.16648524', '6306474.562480859', '6306474.562480859', '1'], ['1741650600000', '78950.4', '78987.6', '78762.7', '78791.4', '31.26918114', '2467218.146049025', '2467218.146049025', '1'], ['1741650300000', '79228.4', '79228.5', '78789.3', '78952.1', '32.05980566', '2530621.38771415', '2530621.38771415', '1'], ['1741650000000', '79301.1', '79329.9', '79204.8', '79228.5', '9.57943577', '759363.085977064', '759363.085977064', '1'], ['1741649700000', '79308.5', '79381.9', '79162.6', '79298', '23.51782058', '1864250.825898441', '1864250.825898441', '1'], ['1741649400000', '79209.2', '79331.5', '79058', '79308.4', '27.24096994', '2156263.581548169', '2156263.581548169', '1'], ['1741649100000', '79290', '79333.2', '79088.5', '79209.1', '9.78562655', '775222.778801615', '775222.778801615', '1'], ['1741648800000', '79127.9', '79294.8', '79041.9', '79286.6', '20.17586622', '1597237.702259759', '1597237.702259759', '1'], ['1741648500000', '79409.4', '79453.1', '78966.7', '79127.9', '35.47580395', '2807343.742908689', '2807343.742908689', '1'], ['1741648200000', '79609', '79700', '79409.3', '79409.3', '10.68049144', '850050.327471551', '850050.327471551', '1'], ['1741647900000', '79608.7', '79678.7', '79389.6', '79609.1', '22.91399377', '1823450.792370128', '1823450.792370128', '1'], ['1741647600000', '79503', '79715.4', '79474.2', '79608.7', '19.51684726', '1553348.386913911', '1553348.386913911', '1'], ['1741647300000', '79659.6', '79717.3', '79500', '79502', '44.04905273', '3509555.8127663', '3509555.8127663', '1'], ['1741647000000', '79540', '79669.7', '79434.3', '79656.7', '33.51111589', '2666591.757008134', '2666591.757008134', '1'], ['1741646700000', '79216.6', '79583.4', '79216.6', '79540.3', '27.44289182', '2180688.004351704', '2180688.004351704', '1'], ['1741646400000', '79358.1', '79393.3', '79216.6', '79216.6', '8.2636238', '655356.587859035', '655356.587859035', '1'], ['1741646100000', '79285.8', '79439.2', '79236.9', '79358.2', '12.17877857', '966640.353581129', '966640.353581129', '1'], ['1741645800000', '79309.2', '79449.9', '79235.6', '79285.7', '19.53199082', '1549851.472566231', '1549851.472566231', '1'], ['1741645500000', '79320.5', '79450', '79207.1', '79311', '16.53320555', '1311051.96033698', '1311051.96033698', '1'], ['1741645200000', '79296.4', '79390.6', '79200.1', '79320.5', '17.47434312', '1385541.774176447', '1385541.774176447', '1'], ['1741644900000', '79442.2', '79446', '79242', '79296.5', '11.66286821', '925180.417731318', '925180.417731318', '1'], ['1741644600000', '79334.9', '79490', '79333.7', '79434.8', '11.84093222', '940292.060580513', '940292.060580513', '1'], ['1741644300000', '79712.5', '79721.9', '79291', '79328.1', '18.77924535', '1492589.657803906', '1492589.657803906', '1'], ['1741644000000', '79571.9', '79848', '79473.1', '79706', '26.29894025', '2095057.289056988', '2095057.289056988', '1'], ['1741643700000', '79400.1', '79676.8', '79400', '79571.3', '9.46145882', '752365.546234793', '752365.546234793', '1'], ['1741643400000', '79467.7', '79650.3', '79400', '79400.1', '9.08429112', '722317.780132319', '722317.780132319', '1'], ['1741643100000', '79631.5', '79650.9', '79467.6', '79467.7', '10.71807919', '852679.197798301', '852679.197798301', '1'], ['1741642800000', '79839.3', '79882.4', '79614.5', '79631.5', '29.32476793', '2339223.458505682', '2339223.458505682', '1'], ['1741642500000', '79584.1', '79887.8', '79576.9', '79842', '21.35998216', '1704750.805307919', '1704750.805307919', '1'], ['1741642200000', '79571.6', '79610.7', '79449', '79584.1', '21.55791596', '1714473.878457337', '1714473.878457337', '1'], ['1741641900000', '79534.5', '79640.8', '79481.5', '79571.6', '17.48042179', '1390859.316980298', '1390859.316980298', '1'], ['1741641600000', '79409', '79533.3', '79223.3', '79533.3', '28.63809364', '2272916.774164858', '2272916.774164858', '1'], ['1741641300000', '79650', '79655.7', '79370.9', '79412.9', '11.91853344', '947287.615218453', '947287.615218453', '1'], ['1741641000000', '79313.2', '79679.3', '79310.8', '79649.9', '80.50296439', '6397069.632562143', '6397069.632562143', '1'], ['1741640700000', '79135.9', '79328.1', '78955.4', '79316.5', '22.51393041', '1781659.378046521', '1781659.378046521', '1'], ['1741640400000', '79300.1', '79334', '79069.7', '79135.6', '17.11073571', '1355237.338301981', '1355237.338301981', '1'], ['1741640100000', '79468', '79748.9', '79300.1', '79300.1', '94.32928095', '7508031.865337466', '7508031.865337466', '1'], ['1741639800000', '78858.4', '79491.9', '78858.4', '79468', '108.73020059', '8623376.536933608', '8623376.536933608', '1'], ['1741639500000', '78750', '78858', '78407', '78858', '70.13624178', '5516260.096645771', '5516260.096645771', '1'], ['1741639200000', '78823.4', '78878.1', '78692.4', '78749.9', '25.60072253', '2017285.836517255', '2017285.836517255', '1'], ['1741638900000', '78822.5', '78861.9', '78694.3', '78824.1', '21.68102961', '1707753.902568791', '1707753.902568791', '1'], ['1741638600000', '79058.8', '79183.5', '78821.8', '78824', '38.73383766', '3058770.529914203', '3058770.529914203', '1'], ['1741638300000', '78899.2', '79118.1', '78886.7', '79057.2', '18.77424295', '1483731.649239671', '1483731.649239671', '1'], ['1741638000000', '78930', '78930', '78696.6', '78899.2', '85.93401166', '6769426.854179968', '6769426.854179968', '1'], ['1741637700000', '78940.5', '79000', '78750.3', '78930.1', '36.50678256', '2879621.20436218', '2879621.20436218', '1'], ['1741637400000', '78811.7', '78956', '78649', '78940.6', '42.21271869', '3328231.484025975', '3328231.484025975', '1'], ['1741637100000', '79014.1', '79062', '78750.1', '78811.6', '22.0886051', '1743244.022441547', '1743244.022441547', '1'], ['1741636800000', '79072', '79137.3', '78732.6', '79010.2', '62.74443184', '4953894.874542624', '4953894.874542624', '1'], ['1741636500000', '78962.1', '79200', '78859.3', '79063.8', '141.89523321', '11209482.809562783', '11209482.809562783', '1'], ['1741636200000', '78926.3', '79257.9', '78840.5', '78967.1', '67.60885794', '5343835.0559193', '5343835.0559193', '1'], ['1741635900000', '78744.9', '78930.9', '78690.8', '78926.2', '73.46378516', '5789149.77101681', '5789149.77101681', '1'], ['1741635600000', '79312.2', '79330.9', '78710.2', '78737.1', '99.61728535', '7861119.226925461', '7861119.226925461', '1'], ['1741635300000', '79459.8', '79474', '79072.1', '79311.2', '64.11712477', '5082960.447209267', '5082960.447209267', '1'], ['1741635000000', '78600.6', '79531.9', '78592', '79458.2', '111.13502178', '8793595.499563795', '8793595.499563795', '1'], ['1741634700000', '78674.6', '78936.1', '78557.5', '78596.3', '113.9711035', '8981232.413945705', '8981232.413945705', '1'], ['1741634400000', '78374.1', '78697.9', '78204.7', '78672.1', '109.70125891', '8600356.214326732', '8600356.214326732', '1'], ['1741634100000', '78020', '78600', '78000.1', '78374.1', '120.25098312', '9412714.09516383', '9412714.09516383', '1'], ['1741633800000', '77737.9', '78184.1', '77550.8', '78022.4', '104.72112838', '8157442.057546936', '8157442.057546936', '1'], ['1741633500000', '77554.3', '77878.3', '77529.3', '77737.9', '103.87864169', '8072398.655392632', '8072398.655392632', '1'], ['1741633200000', '77660.8', '77957.8', '77464', '77558.1', '137.18626131', '10656565.80819081', '10656565.80819081', '1'], ['1741632900000', '77841.8', '77910.6', '77500', '77659.2', '290.26032825', '22546565.979814089', '22546565.979814089', '1'], ['1741632600000', '78244', '78427.7', '77800', '77836', '314.5419135', '24533796.080062482', '24533796.080062482', '1'], ['1741632300000', '78584.9', '78594.4', '78221.2', '78242.9', '54.76905246', '4293289.644455962', '4293289.644455962', '1'], ['1741632000000', '78228.3', '78658.1', '78228.3', '78583.4', '45.21895205', '3548116.835172578', '3548116.835172578', '1'], ['1741631700000', '78333.8', '78369.1', '78165.8', '78229.3', '80.42515386', '6294319.050187645', '6294319.050187645', '1'], ['1741631400000', '78503.4', '78742.2', '78268.8', '78337.8', '63.31806867', '4970444.547441834', '4970444.547441834', '1'], ['1741631100000', '78443.4', '78503.4', '78250', '78503.3', '63.9785263', '5013154.383970479', '5013154.383970479', '1']]
    df = pd.DataFrame(result)
    col = ['timestamp','open','high','close','low','volume','amount','-','-']
    df.columns=col
    df['datetime'] = pd.to_datetime(df['timestamp'], unit='ms')
    df = df[['datetime','open','high','close','low','volume','amount','timestamp']]
    print(df)


if __name__ == '__main__':
    api_key = "ff633c9f-eeb1-4073-bfbc-de5a93af409c"
    secret_key = "B0C40F0CE489B41E13B05495110D978D"
    passphrase = "Jay@541430183"
    flag = '1'
    marketAPI = MarketAPI(api_key, secret_key, passphrase, False, flag)
    coin = 'BTC-USDT'
    get_coin_data(coin)
